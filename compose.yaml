name: zzan

services:
    # RDB: PostgreSQL with PostGIS
    postgres:
        image: 'postgis/postgis:16-3.4'
        container_name: zzan-postgres
        environment:
            - POSTGRES_DB=${POSTGRES_DB}
            - POSTGRES_PASSWORD=${POSTGRES_PASSWORD}
            - POSTGRES_USER=${POSTGRES_USER}
        ports:
            - '${POSTGRES_PORT:-5432}:5432'
        # PostgreSQL logging configuration
        command: [
            "postgres",
            "-c", "log_min_messages=warning",
            "-c", "log_min_error_statement=error",
            "-c", "log_min_duration_statement=500",
            "-c", "log_statement=none"
        ]
        volumes:
            - postgres_data:/var/lib/postgresql/data
        logging:
            driver: "json-file"
            options:
                max-size: "10m"
                max-file: "3"
        healthcheck:
            test: [ "CMD-SHELL", "pg_isready -U ${POSTGRES_USER} -d ${POSTGRES_DB}" ]
            interval: 10s
            timeout: 5s
            retries: 5
        networks:
            - app_network

    # Memory Cache: Redis
    redis:
        image: 'redis:latest'
        container_name: zzan-redis
        ports:
            - '${REDIS_PORT:-6379}:6379'
        volumes:
            - redis_data:/data
        logging:
            driver: "json-file"
            options:
                max-size: "5m"
                max-file: "2"
        healthcheck:
            test: [ "CMD", "redis-cli", "ping" ]
            interval: 10s
            timeout: 3s
            retries: 5
        networks:
            - app_network

    # Main Application
    web:
        image: 'sunbeen/zzan-main:latest'
        container_name: zzan-web
        environment:
            - SPRING_PROFILES_ACTIVE=${SPRING_PROFILES_ACTIVE:-default}
            # Database configuration
            - DATABASE_URL=postgres://${POSTGRES_USER}:${POSTGRES_PASSWORD}@postgres:5432/${POSTGRES_DB}
            - POSTGRES_USER=${POSTGRES_USER}
            - POSTGRES_PASSWORD=${POSTGRES_PASSWORD}
            - POSTGRES_DB=${POSTGRES_DB}
            # Redis configuration
            - REDIS_URL=redis://redis:6379
            # JWT Secret Key
            - JWT_SECRET_KEY=${JWT_SECRET}
            # Kakao API Key
            - KAKAO_CLIENT_ID=${KAKAO_CLIENT_ID}
            - KAKAO_REDIRECT_URI=${KAKAO_REDIRECT_URI}
            - KAKAO_MAP_REST_KEY=${KAKAO_MAP_REST_KEY}
            - SECURITY_ROLE=${SECURITY_ROLE:-USER}
            - AWS_ACCESS_KEY=${AWS_ACCESS_KEY}
            - AWS_SECRET_KEY=${AWS_SECRET_KEY}
            - AWS_REGION=${AWS_REGION:-ap-northeast-2}
            - AWS_S3_BUCKET=${AWS_S3_BUCKET}
        ports:
            - '${WEB_PORT:-8080}:8080'
        logging:
            driver: "json-file"
            options:
                max-size: "20m"
                max-file: "3"
        depends_on:
            postgres:
                condition: service_healthy
            redis:
                condition: service_healthy
        networks:
            - app_network

    # Better Stack Log Agent
    vector:
        image: timberio/vector:0.34.X-debian
        container_name: vector-agent
        user: root
        environment:
            - BETTER_STACK_SOURCE_TOKEN=${BETTER_STACK_SOURCE_TOKEN}
        volumes:
            - /var/lib/docker/containers:/var/lib/docker/containers:ro
            - /var/run/docker.sock:/var/run/docker.sock:ro
            - ./vector.yaml:/etc/vector/vector.yaml:ro
        restart: unless-stopped
        depends_on:
            - web
        networks:
            - app_network

networks:
    app_network:
        driver: bridge

volumes:
    postgres_data:
    redis_data:
